<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Capturador de Resguardos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- pdf-lib para generar PDFs -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <!-- Librería para escanear códigos de barras -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Oculta el input de archivo por defecto, lo activamos con el botón-label */
        input[type="file"] { display: none; }
        .camera-button { cursor: pointer; transition: all 0.2s ease-in-out; }
        .camera-button:hover { transform: scale(1.05); }
        .image-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview .placeholder { color: #6b7280; }
        .component-card {
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Los estilos del modal del escáner ahora se manejan con Tailwind en el HTML */
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-3xl mx-auto bg-white rounded-b-2xl shadow-lg p-6 md:p-8 space-y-6">
        
        <!-- Encabezado Formal -->
        <header class="text-center border-b pb-4 mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Resguardo de Equipo Informático</h1>
            <p class="text-md text-gray-600 mt-2">Regional Occidente</p>
            <p class="text-md text-gray-500">Unidad Operativa Jalisco</p>
        </header>

        <!-- Sección de Participantes -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Información del Resguardo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="entrega" class="block text-sm font-medium text-gray-600 mb-1">Nombre de Quien Entrega:</label>
                    <input type="text" id="entrega" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nombre completo">
                </div>
                <div>
                    <label for="recibe" class="block text-sm font-medium text-gray-600 mb-1">Nombre de Quien Recibe:</label>
                    <input type="text" id="recibe" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nombre completo">
                </div>
            </div>
        </div>

        <!-- Sección de Componentes (Dinámica) -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4">Lista de Componentes</h2>
            <div id="componentes-container" class="space-y-6">
                <!-- Las tarjetas de componentes se insertarán aquí dinámicamente -->
            </div>
            <button id="addComponenteBtn" class="mt-4 w-full flex items-center justify-center gap-2 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                <span>Añadir Componente</span>
            </button>
        </div>

        <!-- Botón de Acción Principal -->
        <div class="pt-4">
            <button id="generatePdf" class="w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                <span>Generar y Descargar Resguardo</span>
            </button>
        </div>
    </div>

    <!-- Contenedor del Escáner (Modal) -->
    <div id="scanner-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        <div class="w-full max-w-md bg-white rounded-lg shadow-2xl overflow-hidden">
            <div id="reader" class="w-full"></div>
        </div>
        <button id="stopScannerBtn" class="mt-6 bg-red-600 text-white font-bold py-2 px-8 rounded-full shadow-lg hover:bg-red-700 transition-transform transform hover:scale-105">Cancelar</button>
    </div>


    <!-- Modales de Carga y Alerta -->
    <div id="loadingModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center gap-4 shadow-xl">
            <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span class="text-lg font-medium text-gray-700">Generando PDF...</span>
        </div>
    </div>
    <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center shadow-xl">
            <h3 id="alertTitle" class="text-xl font-bold text-red-600 mb-2">Error</h3>
            <p id="alertMessage" class="text-gray-700 mb-6">Mensaje de alerta.</p>
            <button id="closeAlert" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Entendido</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS DEL DOM ---
        const componentesContainer = document.getElementById('componentes-container');
        const addComponenteBtn = document.getElementById('addComponenteBtn');
        const generatePdfBtn = document.getElementById('generatePdf');
        const loadingModal = document.getElementById('loadingModal');
        const alertModal = document.getElementById('alertModal');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        const closeAlertBtn = document.getElementById('closeAlert');
        let componenteCounter = 0;

        // --- MANEJO DE MODALES ---
        const showAlert = (title, message) => {
            alertTitle.textContent = title;
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        };
        closeAlertBtn.addEventListener('click', () => alertModal.classList.add('hidden'));

        // --- LÓGICA PARA AÑADIR COMPONENTES ---
        const addComponente = () => {
            componenteCounter++;
            const componentId = componenteCounter;

            const card = document.createElement('div');
            card.className = 'component-card border border-gray-200 rounded-lg p-4 space-y-4 bg-gray-50';
            card.id = `componente-${componentId}`;

            // --- PLANTILLA HTML PARA CADA TARJETA DE COMPONENTE ---
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <!-- AJUSTE: Se quita el número del componente del título -->
                    <h3 class="text-md font-bold text-gray-800 pt-1">Componente</h3>
                    <button class="delete-btn text-red-500 hover:text-red-700" data-id="${componentId}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" class="tipo w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Tipo de Componente (Ej: Laptop)">
                    <input type="text" class="marca w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Marca y Modelo">
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="text" class="serie w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Número de Serie">
                    <button class="scan-btn p-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600" data-target-id="${componentId}" title="Escanear código de barras">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zM3 16a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" /></svg>
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">Estado de Propiedad:</label>
                    <select class="propiedad w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
                        <option value="Arrendado">Arrendado</option>
                        <option value="Propiedad de la Empresa">Propiedad de la Empresa</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                    <div class="space-y-2">
                        <label for="fotoEquipo-${componentId}" class="camera-button w-full flex items-center justify-center gap-2 bg-white border-2 border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                           Foto del Componente
                        </label>
                        <input type="file" id="fotoEquipo-${componentId}" class="foto-equipo" accept="image/*" capture="environment">
                        <div class="image-preview preview-equipo"><span class="placeholder">Vista Previa</span></div>
                    </div>
                    <div class="space-y-2">
                        <label for="fotoSerie-${componentId}" class="camera-button w-full flex items-center justify-center gap-2 bg-white border-2 border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect><path d="M7 12h10"></path><path d="M12 7v10"></path></svg>
                           Foto del No. Serie
                        </label>
                        <input type="file" id="fotoSerie-${componentId}" class="foto-serie" accept="image/*" capture="environment">
                        <div class="image-preview preview-serie"><span class="placeholder">Vista Previa</span></div>
                    </div>
                </div>
            `;
            componentesContainer.appendChild(card);
        };

        addComponenteBtn.addEventListener('click', addComponente);

        // --- LÓGICA DEL ESCÁNER DE CÓDIGO DE BARRAS ---
        const scannerModal = document.getElementById('scanner-modal');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const html5QrCode = new Html5Qrcode("reader");
        let activeSerieInput = null;

        const startScanner = (targetInput) => {
            activeSerieInput = targetInput;
            scannerModal.classList.remove('hidden');
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 150 } },
                (decodedText, decodedResult) => {
                    if (activeSerieInput) activeSerieInput.value = decodedText;
                    stopScanner();
                },
                (errorMessage) => { /* Ignorar errores */ }
            ).catch((err) => {
                showAlert('Error de Cámara', 'No se pudo acceder a la cámara. Asegúrate de haber otorgado los permisos necesarios.');
                stopScanner();
            });
        };

        const stopScanner = () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.warn("Fallo al detener escáner.", err));
            }
            scannerModal.classList.add('hidden');
            activeSerieInput = null;
        };

        stopScannerBtn.addEventListener('click', stopScanner);

        // --- MANEJO DE EVENTOS DINÁMICOS ---
        componentesContainer.addEventListener('click', (e) => {
            const scanBtn = e.target.closest('.scan-btn');
            const deleteBtn = e.target.closest('.delete-btn');

            if (scanBtn) {
                const targetId = scanBtn.dataset.targetId;
                const targetInput = document.querySelector(`#componente-${targetId} .serie`);
                if (targetInput) startScanner(targetInput);
            }

            if (deleteBtn) {
                const componentId = deleteBtn.dataset.id;
                const cardToRemove = document.getElementById(`componente-${componentId}`);
                if (cardToRemove) cardToRemove.remove();
            }
        });

        componentesContainer.addEventListener('change', (e) => {
            if (e.target.matches('.foto-equipo') || e.target.matches('.foto-serie')) {
                const previewElement = e.target.closest('.space-y-2').querySelector('.image-preview');
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewElement.innerHTML = `<img src="${event.target.result}" alt="Vista previa">`;
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // --- LÓGICA PRINCIPAL: GENERACIÓN DE PDF ---
        generatePdfBtn.addEventListener('click', async () => {
            const entrega = document.getElementById('entrega').value;
            const recibe = document.getElementById('recibe').value;
            const componentes = document.querySelectorAll('.component-card');

            if (!entrega || !recibe) return showAlert('Faltan Nombres', 'Debes especificar quién entrega y quién recibe el equipo.');
            if (componentes.length === 0) return showAlert('Sin Componentes', 'Debes añadir al menos un componente.');
            
            let allValid = true;
            componentes.forEach((card) => {
                if (!card.querySelector('.tipo').value || !card.querySelector('.serie').value || !card.querySelector('.foto-equipo').files.length) {
                    allValid = false;
                }
            });
            if (!allValid) return showAlert('Datos Incompletos', 'Cada componente debe tener al menos: Tipo, Número de Serie y la Foto del Componente.');

            loadingModal.classList.remove('hidden');

            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const pdfDoc = await PDFDocument.create();
                let page = pdfDoc.addPage();
                const { width, height } = page.getSize();
                const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                let y = height - 40;
                const margin = 40;

                const checkNewPage = (spaceNeeded) => {
                    if (y - spaceNeeded < margin) {
                        page = pdfDoc.addPage();
                        y = height - margin;
                    }
                };

                // --- Escribiendo el contenido del PDF ---
                page.drawText('Resguardo de Equipo Informático', { x: margin, y, font: fontBold, size: 20 });
                y -= 25;
                page.drawText('Regional Occidente - Unidad Operativa Jalisco', { x: margin, y, font, size: 12 });
                y -= 20;
                const fecha = new Date().toLocaleString('es-MX', { dateStyle: 'long', timeStyle: 'short' });
                page.drawText(`Fecha de Resguardo: ${fecha}`, { x: margin, y, font, size: 10, color: rgb(0.4, 0.4, 0.4) });
                y -= 40;

                page.drawLine({ start: { x: margin, y }, end: { x: width - margin, y }, thickness: 1.5, color: rgb(0.1, 0.1, 0.1) });
                y -= 25;
                page.drawText('Lista de Componentes', { x: margin, y, font: fontBold, size: 16 });
                y -= 25;

                for (const card of componentes) {
                    const tipo = card.querySelector('.tipo').value;
                    const marca = card.querySelector('.marca').value;
                    const serie = card.querySelector('.serie').value;
                    const propiedad = card.querySelector('.propiedad').value;
                    const imgEquipoSrc = card.querySelector('.preview-equipo img')?.src;
                    const imgSerieSrc = card.querySelector('.preview-serie img')?.src;
                    
                    // AJUSTE: Cálculo dinámico de espacio requerido
                    let componentHeight = 80; // Espacio base para texto
                    if (imgEquipoSrc || imgSerieSrc) {
                        componentHeight += 140; // Espacio para la fila de imágenes
                    }
                    checkNewPage(componentHeight);
                    
                    page.drawText(`Componente: ${tipo} ${marca || ''}`, { x: margin, y, font: fontBold, size: 13 });
                    y -= 20;
                    
                    const drawField = (label, value) => {
                        if (!value) return;
                        page.drawText(label, { x: margin + 10, y, font: fontBold, size: 11 });
                        page.drawText(value, { x: margin + 100, y, font, size: 11 });
                        y -= 20;
                    };

                    drawField('No. de Serie:', serie);
                    drawField('Propiedad:', propiedad);
                    y -= 10;

                    const imgMaxWidth = (width - margin * 3) / 2;
                    const imgMaxHeight = 120;
                    let imagesHeight = 0;

                    if (imgEquipoSrc) {
                        const imgEquipoBytes = await fetch(imgEquipoSrc).then(res => res.arrayBuffer());
                        const imgEquipo = imgEquipoSrc.startsWith('data:image/png') ? await pdfDoc.embedPng(imgEquipoBytes) : await pdfDoc.embedJpg(imgEquipoBytes);
                        const equipoDims = imgEquipo.scaleToFit(imgMaxWidth, imgMaxHeight);
                        page.drawImage(imgEquipo, { x: margin, y: y - equipoDims.height, ...equipoDims });
                        imagesHeight = Math.max(imagesHeight, equipoDims.height);
                    }
                    
                    if (imgSerieSrc) {
                        const imgSerieBytes = await fetch(imgSerieSrc).then(res => res.arrayBuffer());
                        const imgSerie = imgSerieSrc.startsWith('data:image/png') ? await pdfDoc.embedPng(imgSerieBytes) : await pdfDoc.embedJpg(imgSerieBytes);
                        const serieDims = imgSerie.scaleToFit(imgMaxWidth, imgMaxHeight);
                        page.drawImage(imgSerie, { x: margin + imgMaxWidth + margin, y: y - serieDims.height, ...serieDims });
                        imagesHeight = Math.max(imagesHeight, serieDims.height);
                    }
                    
                    if (imagesHeight > 0) {
                        y -= imagesHeight + 15;
                    }
                    
                    page.drawLine({ start: { x: margin, y }, end: { x: width - margin, y }, thickness: 0.5, color: rgb(0.8, 0.8, 0.8) });
                    y -= 20;
                }

                // --- AJUSTE: Firmas al final con nombres ---
                checkNewPage(120);
                y = margin + 80;
                page.drawText('De conformidad, las partes firman el presente resguardo:', { x: margin, y, font, size: 10 });
                y -= 50;
                
                // Dibuja el nombre de quien entrega
                page.drawText(entrega, { x: margin, y, font, size: 11, maxWidth: 220, align: 'center' });
                // Dibuja el nombre de quien recibe
                page.drawText(recibe, { x: width - margin - 220, y, font, size: 11, maxWidth: 220, align: 'center' });
                y -= 5;
                
                page.drawLine({ start: { x: margin, y }, end: { x: margin + 220, y }, thickness: 1 });
                page.drawLine({ start: { x: width - margin - 220, y }, end: { x: width - margin, y }, thickness: 1 });
                y -= 15;
                page.drawText('Quien Entrega', { x: margin, y, font: fontBold, size: 10, maxWidth: 220, align: 'center' });
                page.drawText('Quien Recibe', { x: width - margin - 220, y, font: fontBold, size: 10, maxWidth: 220, align: 'center' });

                // --- Guardar y descargar el PDF ---
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const fileNameDate = new Date().toISOString().slice(0, 10);
                link.download = `Resguardo_${recibe.replace(/\s+/g, '_')}_${fileNameDate}.pdf`;
                link.click();
                URL.revokeObjectURL(link.href);

            } catch (error) {
                console.error('Error al generar el PDF:', error);
                showAlert('Error Inesperado', 'Ocurrió un problema al generar el PDF. Revisa que las imágenes sean válidas (JPG/PNG).');
            } finally {
                loadingModal.classList.add('hidden');
            }
        });
        
        addComponente();
    });
    </script>
</body>
</html>
